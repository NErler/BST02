---
title: "BST02: Using R for Statistics\\ in Medical Research"
subtitle: "Part D: Statistics with R"
author: "Nicole Erler"
institute: "Department of Biostatistics, Erasmus Medical Center"
date: "24 - 28 February 2020"
email: "n.erler@erasmusmc.nl"
output:
  beamer_presentation: 
    template: mytemplate.latex
    includes:
      in_header: SlideTemplate.tex
    incremental: false
classoption: aspectratio=169
---

```{r setup, include=FALSE}
knitr::knit_hooks$set(
  nospace = function(before, options, envir) {
    if (before) {
      knitr::asis_output("\\vspace*{-1.5ex}")
    }
  }
)

knitr::opts_chunk$set(echo = TRUE, nospace = TRUE, nospaceafter = TRUE)

```

## In this Section

* Common statistical tests
  - for continuous data
  - for categorical data
* (Generalized) linear regression
* Useful functions for regression models


## t-test: `t.test()`
\blue{One-sample t-test}

* compares the \blue{mean of one sample} with a fixed value $\mu$

\pause
\bigskip

\blue{Two sample / independent samples t-test}

* compares the \blue{difference between the means} of two samples with a fixed value $\mu$

\pause
\bigskip

\blue{Related samples t-test}

* compares the \blue{mean of the difference} between related observations with a fixed value $\mu$
  (same as one-sample t-test)

## Wilcoxon Test: `wilcox.test()`
\blue{Wilcoxon Signed Rank Test}

* tests if \blue{one sample} (or the differences between two paired samples) is/are 
  \blue{symmetric about $\mu$}

\pause\bigskip

\blue{Wilcoxon Rank Sum Test / Mann-Whitney test}

* test for a \blue{location shift between the distributions} of two independent samples

\bigskip
\vfill
See also [BBR Sections 7.2 & 7.3 (http://hbiostat.org/doc/bbr.pdf)](http://hbiostat.org/doc/bbr.pdf)


## Kruskal-Wallis Rank Sum Test: `kruskal.test()`

\begin{itemize}\itemsep4mm
\item \blue{extension} of the Wilcoxon rank sum test for \blue{more than two groups}
\item test for a \blue{difference in location} of a continuous variable between multiple groups
\item the \blue{Wilcoxon rank sum test is a special case} of the Kruskal-Wallis rank sum test
\end{itemize}

## Other tests for continuous data

\begin{itemize}\itemsep5mm
\item \blue{Kolmogoriv-Smirnov Test:} `ks.test()`\newline
  tests if two samples are drawn from the same continuous distribution
  
\item \blue{Shapiro-Wilk Normality Test:} `shapiro.test()`

\item \blue{Friedman Rank Sum Test:} `friedman.test()`\newline
  non-parametric test for two or more related samples
  
\item ...
\end{itemize}


## Tests for Continuous Data

\begin{columns}
\begin{column}{0.47\linewidth}
\begin{block}{Demo}
\begin{itemize}
\item Tests for Continuous Data\newline \button{https://nerler.github.io/BST02/demo/Statistics_with_R/Tests_for_Continuous_Data.R}{R}
\button{https://nerler.github.io/BST02/demo/Statistics_with_R/Tests_for_Continuous_Data.html}{html}
\end{itemize}
\end{block}
\end{column}
\begin{column}{0.47\linewidth}
\begin{block}{Demo}
\begin{itemize}
\item Tests for Continuous Data\newline \button{https://nerler.github.io/BST02/practical/Statistics_with_R/Tests_for_Continuous_Data.html}{html}
\end{itemize}
\end{block}
\end{column}
\end{columns}


## Tests for Categorical Data / Proportions

\blue{One-sample Proportion Test}
* tests if the \blue{proportion in one sample} is equal to a fixed value $p$
* `prop.test()` and `binom.test()`

\pause\bigskip

\blue{Tests for Proportions in Multiple (independent) Groups}
* tests if the \blue{proportions in several samples} are equal
* `chisq.test()` and `fisher.test()` (when there are cells with 0)

\bigskip\vfill

See also [BBR Sections 5.7 & 6 (http://hbiostat.org/doc/bbr.pdf)](http://hbiostat.org/doc/bbr.pdf)

## Tests for Categorical Data / Proportions
\blue{Related Samples: McNemar Test}
 * Tests for \blue{symmetry} in a $2\times 2$ table
 * `mcnemar.test()`
 
 
\pause\bigskip


\blue{3-Dimensional Contingency Table}
* Cochrane-Mantel-Haenszel Test
* $\chi^2$ test for \blue{independence} of two nominal variables \blue{within each stratum}
* `mantelhaen.test()`


## Tests for Categorical Data

\begin{center}
\begin{columns}
\begin{column}{0.47\linewidth}
\begin{block}{Demo}
\begin{itemize}
\item Tests for Categorical Data\newline \button{https://nerler.github.io/BST02/demo/Statistics_with_R/Tests_for_Categorical_Data.R}{R}
\button{https://nerler.github.io/BST02/demo/Statistics_with_R/Tests_for_Categorical_Data.html}{html}
\end{itemize}
\end{block}
\end{column}
\end{columns}
\end{center}


## Statistical Tests
\begin{columns}[onlytextwidth,T]
\begin{column}{0.3\linewidth}

\blue{Continuous Outcomes}
\begin{itemize}\vspace*{-0.5ex}
\item \texttt{t.test()}
\item \texttt{wilcox.test()}
\item \texttt{kruskal.test()}
\item \texttt{ks.test()}
\item \texttt{friedman.test()}
\item \texttt{shapiro.test()}
\end{itemize}
\end{column}

\begin{column}{0.4\linewidth}
\blue{Categorical Outcomes}
\begin{itemize}\vspace*{-0.5ex}
\item \texttt{prop.test()}
\item \texttt{binom.test()}
\item \texttt{chisq.test()}
\item \texttt{fisher.test()}
\item \texttt{mcnemar.test()}
\item \texttt{mantelhaen.test()}
\end{itemize}

\bigskip

\blue{Pairwise tests}
\begin{itemize}
\item \texttt{pairwise.prop.test()}
\item \texttt{pairwise.t.test()}
\item \texttt{pairwise.wilcox.test()}
\end{itemize}
\end{column}

\begin{column}{0.3\linewidth}
\blue{Variance and Correlation}
\begin{itemize}\vspace*{-0.5ex}
\item \texttt{cor.test()}
\item \texttt{bartlett.test()}
\item \texttt{var.test()}
\end{itemize}

\bigskip

\blue{Multiple Testing Adjustment}
\begin{itemize}
\item \texttt{p.adjust()}
\end{itemize}
\end{column}
\end{columns}


## Linear Regression

A standard linear regression model has the form
$$ y = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \ldots + \beta_p x_p + \varepsilon
\qquad \text{with } \varepsilon \sim N(0, \sigma^2)$$


where

* \blue{$y$} is the \blue{outcome} variable ("dependent variable")
* \blue{$x_1, \ldots, x_p$} are the \blue{covariates} ("independent variables")
* \blue{$\beta_0, \ldots, \beta_p$} are the \blue{regression coefficients}
  * $\beta_0$ is the intercept
  * $\beta_1, \ldots, \beta_p$ estimate the effects of the covariates
* \blue{$\varepsilon$} is a vector of \blue{residuals}, which we assume to be
  (approximately) normally distributed.


## Linear Regression 

To fit a \blue{linear regression} in R we use the function \blue{\texttt{lm()}}.

The most important arguments are

* \blue{\texttt{formula}}:\newline a `formula` object
* \blue{\texttt{data}}: \newline a `data.frame` (optional, but usually needed)
* \blue{\texttt{subset}}:\newline a `vector` specifying which observations should be used (optional)


## Model Formula
A `formula` object has the form
```{r, eval = FALSE}
outcome ~ linear predictor
```
for example
```{r, eval = FALSE}
y ~ x1 + x2 + x3
```

* Variables are separated by "\texttt{\blue{+}}" signs.
* An intercept is automatically included.
* one-sided formulas (omitting the outcome) are possible\newline
  (used for random effects specification)

## Model Formula: Interactions
Interaction terms are written using "\blue{\texttt{:}}" or "\blue{\texttt{*}}".

"\blue{\texttt{*}}" includes the main effects and interaction terms, i.e., 
```{r, eval = FALSE}
y ~ x1 * x2
```
\vspace*{-2ex}is equivalent to
```{r, eval = FALSE}
y ~ x1 + x2 + x1:x2
```

Interactions between multiple variables can be written using "\blue{\texttt{()}}", i.e.,
```{r, eval = FALSE}
y ~ x1 * (x2 + x3)
```
\vspace*{-2ex}is equivalent to
```{r, eval = FALSE}
y ~ x1 * x2 + x1 * x3
```

## Model Formula: Interactions
To specify a \blue{higher level interaction} (for example a three-way interaction) 
"\blue{\texttt{\^}}" is used, i.e.,
```{r, eval = FALSE}
y ~ (x1 + x2 + x3)^3
```
\vspace*{-2ex}will create all interactions up to 3-way and is equivalent to
```{r, eval = FALSE}
y ~ x1 * x2 * x3
```
\vspace*{-2ex} and equivalent to
```{r, eval = FALSE}
y ~ x1 + x2 + x3 + x1:x2 + x1:x3 + x2:x3 + x1:x2:x3
```
and
```{r, eval = FALSE}
y ~ (x1 + x2 + x3)^2
```
\vspace*{-2ex}will create all two-way interactions and is equivalent to
```{r, eval = FALSE}
y ~ x1 + x2 + x3 + x1:x2 + x1:x3 + x2:x3
```

## Model Formula: Removing terms
The "\blue{\texttt{-}}" sign can be used to remove terms from a model formula, for example
```{r, eval = FALSE}
y ~ x1 * x2 * x3 - x2 - x1:x3
```
\vspace*{-2ex}is equivalent to 
```{r, eval = FALSE}
y ~ x1 + x3 + x1:x2 + x2:x3 + x1:x2:x3
```

The \blue{intercept} can be removed from a formula by using "\blue{\texttt{-1}}"
or "\blue{\texttt{+0}}", i.e.
```{r, eval = FALSE}
y ~ x1 + x2 - 1
y ~ x1 + x2 + 0
```

## Generalized Linear Regression (GLM)
A \blue{generalized linear regression} model has the form
$$g(\mathbb{E}(y)) = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \ldots + \beta_p x_p$$
where $g(\ )$ is a link function and $y$ is from the exponential family.

\vfill

For example \blue{logistic regression} for binary $y$:
$$log\left(\frac{P(y = 1)}{1-P(y = 1)}\right) = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \ldots + \beta_p x_p$$

$log\left(\frac{p}{1-p}\right)$ is the \blue{logit} link.

## Generalized Linear Regression (GLM)
To fit a \blue{GLM} in R we use the function \blue{\texttt{glm()}}.

The most important arguments are

* \blue{\texttt{formula}}:\newline a `formula` object
* \blue{\texttt{family}}: \newline a `family` object or name of the family function,
   describing the error distribution and link function
* \blue{\texttt{data}}: \newline a `data.frame` (optional, but usually needed)
* \blue{\texttt{subset}}:\newline a `vector` specifying which observations should be used (optional)

## Families and Link Functions
Common families \& available links in R: \hfill (see also `?family`)
\begin{center}
\begin{tabular}{ll}
\toprule
family & link\\\midrule
\texttt{binomial} & \texttt{logit}, \texttt{probit}, \texttt{cauchit}, \texttt{log}, \texttt{cloglog}\\
\texttt{gaussian} & \texttt{identity}, \texttt{log}, \texttt{inverse}\\
\texttt{Gamma} & \texttt{inverse}, \texttt{identity}, \texttt{log}\\
\texttt{poisson} & \texttt{log}, \texttt{identity}, \texttt{sqrt}\\
\bottomrule
\end{tabular}
\end{center}

The `family` argument in `glm()` can be specified in the following ways:
\begin{columns}[onlytextwidth]
\begin{column}{0.5\linewidth}
\begin{itemize}
\item \texttt{binomial(link = "logit")}
\item \texttt{binomial()}
\item \texttt{binomial}
\item \texttt{"binomial"}
\end{itemize}
\end{column}
\begin{column}{0.5\linewidth}
\blue{Note:}\\
When the link is not explicitely specified (i.e. option 1),
the default link is used.
\end{column}
\end{columns}


## Regression

\begin{columns}[T,onlytextwidth]
\begin{column}{0.47\linewidth}
\begin{block}{Demo}
\begin{itemize}
\item Regression Basics \button{https://nerler.com}{R} \button{https://nerler.com}{html}
\end{itemize}
\end{block}
\end{column}

\begin{column}{0.47\linewidth}
\begin{block}{Practical}
\begin{itemize}
\item Linear Regression \button{https://nerler.github.io/BST02/practical/Statistics_with_R/Linear_Regression.html}{html}
\item Name of practical \button{link to html file}{html}
\end{itemize}
\end{block}
\end{column}
\end{columns}

```{r, include = FALSE, eval= FALSE}
boot::urine
MASS::birthwt
MASS::Boston
MASS::Cars93
MASS::crabs
MASS::Pima.te
MASS::survey???
MASS::UScereal
MASS::UScrime

rpart::stagec
rpart::car90
```


## Regression
\begin{columns}[onlytextwidth,T]
\begin{column}{0.5\linewidth}

\blue{Regression Models}
\begin{itemize}
\item \texttt{lm()}
\item \texttt{glm()}
\end{itemize}

\bigskip

\blue{Regression Results}
\begin{itemize}\vspace*{-0.5ex}
\item \texttt{summary()}
\item \texttt{coef()}, \texttt{confint()}
\item \texttt{fitted()}, \texttt{residuals()}
\item \texttt{AIC()}, \texttt{BIC()}
\item \texttt{anova()}
\end{itemize}
\end{column}

\begin{column}{0.5\linewidth}
\blue{Plots}
\begin{itemize}\vspace*{-0.5ex}
\item \texttt{plot()}
\item \texttt{qqnorm()}, \texttt{qqline()}, \texttt{qqplot()}
\end{itemize}

\bigskip

\blue{Topic}
\begin{itemize}\vspace*{-0.5ex}
\item \texttt{ns()}, \texttt{bs()}, \texttt{I()}
\item \texttt{p.adjust()}
\item \texttt{all.vars()}
\item \texttt{update()}
\item \texttt{as.formula()}
\end{itemize}

\end{column}
\end{columns}
